#### 服务化拆分

* 纵向拆分，从业务维度进行拆分。比如web端作为一个模块，用户端作为一个模块，等等

* 横向拆分：从公共并且独立的维度进行拆分。标准时按照公共被多个其他服务调用，并且依赖的资源独立不予其他业务耦合。

  > 比如，社交App的昵称，无论是在首页信息，评论还是消息箱，都需要显示用户昵称，如果有新的需求开发完成，那么所有模块都要进行发布。如果昵称作为独立的模块发布就不会影响其他模块。
  >
  > 但是无论怎么样都会出现耦合。

![1584338357124](markdownImage/1584338357124.png)

#### 微服务框架主要依赖的几个基本组件(6个)

​	注册中心(nacos-目前用的、Eureka)，网关：cloud Gateway:，Cloud Feign，Cloud Ribbon，Hystrix，Cloud Admin， XXLJob Admin, Sentinel，ELK

> Eureka 是注册中心。但是Nacos = SpringCloud 注册中心+ SpringCloud配置中心(SpringCloud Config)

- 服务描述：理解为接口文档？

- 注册中心-nacos/eureka：<font color = "red">这个组件必须，</font>服务提供者将服务登记在注册中心。

  > 一般的流程：
  >
  > ​	服务提供者在启动的时候：根据服务发布文件中配置的发布信息向注册中心注册自己的服务。
  >
  > ​	服务消费者在启动的时候：根据消费者配置文件中配置的服务信息向注册中心订阅自己所需要的的服务。注册中心会返回服务提供者地址列表给消费者。
  >
  > ![1584338875044](markdownImage/1584338875044.png)

- 服务框架： 在注册中心获取地址准备调用之前。整个框架的基础内容：

  ①：服务通信是什么协议？四层tcp、udp？ 七层 http？other？

  ②：数据传输采用的方式？ 同步？异步？单连接传输？ 多路复用？

  ③：数据压缩采用的格式？ JSON序列？ java对象序列化？Protobuf序列化？

- 服务监控：就是在正常服务后，对整个框架下的服务进行监控，查看服务是否正常。

  ①：指标收集--把每次服务调用的请求耗时，成功与否等信息上传到数据处理中心。

  ②：数据处理--根据①的数据，计算每秒服务请求量、平均耗时、成功率等指标

  ③：数据展示--展示①、②的数据

- 服务追踪：方便查询故障。每次服务请求后，都会记录服务每一次调用经过的那些链路，方便后续的问题追踪，和故障定位

  > 服务消费者在发起调用前，会在本地按照一定的规则生成一个requestid，发起调用时，将requestuid作为请求参数的部分，传递给服务提供者。
  >
  > 服务器提供者接受到请求后，记录这次的请求的requestid，然后处理请求。如果服务提供者继续请求其他服务，也会在本地生成自己的requestID，然后把这两个requestid当做参数继续往下传递。

- 服务治理-netflix hystrix熔断器：主要是解决各种问题。自动摘除故障节点，自动切换IDC、熔断、限流



#### Nacos

​	nacos = 注册中心eureka + 分布式配置中心 springcloud config。所以Nacos的配置中心(前后端)和注册中心都是部署在同一个单体应用上。默认端口号 8848。

> 分布式配置中心有什么好处？
>
> ​	正常项目的配置和项目是绑定在一块的，如果配置发生变化，必然会重新发布影响线上环境。



##### 分布式配置中心原理

![1584430487629](markdownImage/1584430487629.png)

> 配置中心一般都是长连接。长连接的作用就是监听。
>
> 比较配置之间是否更新，通过比较 版本号|MD5

原理：

* 本地应用读取云端分布式配置中心文件。第一次连接会建立长连接。
* 读取配置文件后，缓存在JVM和硬盘中。
* 本地应用与分布式配置中心保持长连接。
* 当配置文件的版本号或者MD5发生变化，那么及时刷新本地配置文件。

Nacos的使用

​	官网下载

解压运行即可。不过需要将项目的配置文件改成bootstrap.yaml，因为bootstrap 要比 application 先加载。



